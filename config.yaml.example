# =============================================================================
# MAMFast Configuration Example
# =============================================================================
# Copy this file to config/config.yaml and adjust for your setup.
# Environment variables in .env override some settings.
# =============================================================================

# ─────────────────────────────────────────────────────────────────────────────
# Environment / Docker
# ─────────────────────────────────────────────────────────────────────────────
environment:
  libation_container: "Libation"      # Docker container name for Libation
  docker_bin: "/usr/bin/docker"       # Path to docker binary
  target_uid: 99                      # UID for created files (99 = nobody on Unraid)
  target_gid: 100                     # GID for created files (100 = users on Unraid)

# ─────────────────────────────────────────────────────────────────────────────
# Paths
# ─────────────────────────────────────────────────────────────────────────────
paths:
  # Libation library directory (where audiobooks are downloaded/stored)
  library_root: "/path/to/your/audiobook/library"

  # Where .torrent files are written
  torrent_output: "/path/to/torrent/files"

  # qBittorrent seed directory - hardlinks created here for seeding
  seed_root: "/path/to/seedvault/audiobooks"

  # State file for tracking processed releases
  state_file: "./data/processed.json"

  # Log file
  log_file: "./logs/mamfast.log"

# ─────────────────────────────────────────────────────────────────────────────
# MAM Compliance
# ─────────────────────────────────────────────────────────────────────────────
mam:
  max_filename_length: 225            # MAM's filename length limit
  allowed_extensions:
    - ".m4b"
    - ".jpg"
    - ".jpeg"
    - ".png"
    - ".pdf"
    - ".cue"

# ─────────────────────────────────────────────────────────────────────────────
# Title Filters
# Note: remove_phrases and author_map have moved to config/naming.json
# ─────────────────────────────────────────────────────────────────────────────
filters:
  # Remove "Book XX" patterns (we keep vol_XX from Libation naming)
  remove_book_numbers: true

  # Use pykakasi to transliterate unknown Japanese text as fallback
  transliterate_japanese: true

# ─────────────────────────────────────────────────────────────────────────────
# Naming / Output Settings
# ─────────────────────────────────────────────────────────────────────────────
naming:
  # Ripper tag appended to folder names: "[H2OKing]" at end of folder name
  # Used in both Audiobookshelf library and MAM uploads (folder only, not filename)
  # Set to null or empty string to disable
  ripper_tag: "H2OKing"

# ─────────────────────────────────────────────────────────────────────────────
# mkbrr Docker Settings
# ─────────────────────────────────────────────────────────────────────────────
mkbrr:
  image: "ghcr.io/autobrr/mkbrr:latest"
  preset: "mam"                       # mkbrr preset name (contains announce URL)

  # Path mapping: how host paths appear inside the mkbrr container
  host_data_root: "/mnt/user/data"
  container_data_root: "/data"

  # mkbrr config directory mapping (where presets.yaml lives)
  host_config_dir: "/path/to/mkbrr/config"
  container_config_dir: "/root/.config/mkbrr"

# ─────────────────────────────────────────────────────────────────────────────
# qBittorrent Settings
# ─────────────────────────────────────────────────────────────────────────────
# Note: Host, username, and password are read from .env file:
#   QB_HOST=http://localhost:8080
#   QB_USERNAME=admin
#   QB_PASSWORD=yourpassword
qbittorrent:
  category: "upload.audiobooks"       # Category for uploaded torrents
  tags:
    - "mamfast"
    - "auto-upload"
  auto_start: true                    # Start seeding immediately after upload
  # Automatic Torrent Management (TMM):
  #   - When true: qBittorrent manages save paths based on category settings
  #   - When false: Uses save_path below for all uploads
  auto_tmm: false
  # Save path as seen by qBittorrent container (only used when auto_tmm is false)
  save_path: "/data/downloads/torrents/qbittorrent/seedvault/audiobooks"

# ─────────────────────────────────────────────────────────────────────────────
# Audnex API (for fetching audiobook metadata)
# ─────────────────────────────────────────────────────────────────────────────
audnex:
  base_url: "https://api.audnex.us"
  timeout_seconds: 30
  # Regions to try in order when fetching metadata
  # Tries each region in order; returns data from first region where ASIN exists.
  # For English audiobooks, US/UK usually has the best metadata coverage.
  # Some ASINs are region-specific (e.g., US-only or UK-only books).
  # Valid regions: us, uk, au, ca, de, es, fr, in, it, jp
  #
  # Recommended for English content:
  #   regions: [us, uk, au, ca]
  # Full fallback (may return non-English metadata for region-specific books):
  #   regions: [us, uk, au, ca, de, es, fr, in, it, jp]
  regions:
    - us
    # - uk  # Uncomment to add UK as fallback

# ─────────────────────────────────────────────────────────────────────────────
# MediaInfo (for extracting audio file metadata)
# ─────────────────────────────────────────────────────────────────────────────
mediainfo:
  binary: "mediainfo"                 # or full path: /usr/bin/mediainfo

# ─────────────────────────────────────────────────────────────────────────────
# Audiobookshelf Integration (optional)
# ─────────────────────────────────────────────────────────────────────────────
# Note: Host and API token are read from .env file:
#   AUDIOBOOKSHELF_HOST=http://localhost:13378
#   AUDIOBOOKSHELF_API_KEY=your-api-token
audiobookshelf:
  # Enable/disable ABS import integration
  enabled: false

  # Connection timeout
  timeout_seconds: 30

  # Docker path mapping (ABS container path → host path)
  # Required when ABS runs in Docker - paths in API responses are container paths
  # Set docker_mode to false if ABS runs directly on host
  docker_mode: true
  path_map:
    - container: "/audiobooks"
      host: "/path/to/audiobooks"

  # Library configuration (run 'mamfast abs-init' to discover library IDs)
  # Multiple libraries can be defined; only those with mamfast_managed=true are imported
  libraries:
    - id: "lib_xxxxxxxxxxxxx"         # From ABS library ID
      name: "Audiobooks"
      mamfast_managed: true           # Import to this library

  # Import settings
  import:
    # What to do when ASIN already exists in library
    duplicate_policy: skip            # skip | warn | overwrite

    # How to handle books without ASIN (see docs/UNKNOWN_ASIN_HANDLING.md)
    # - import: Import to Unknown/ (missing ASIN) or Author/ (homebrew pattern)
    # - quarantine: Move to quarantine_path for manual review
    # - skip: Leave in staging, log warning only
    unknown_asin_policy: import       # import | quarantine | skip (case-insensitive)

    # Path for quarantined books (required if unknown_asin_policy is 'quarantine')
    # Must be an absolute host path, e.g. /mnt/user/data/quarantine
    # quarantine_path: "/path/to/quarantine"

    # Trigger ABS library scan after import?
    # none: Don't scan (manual rescan required)
    # each: Scan after each book (slower but immediate)
    # batch: Scan once after all imports complete (recommended)
    trigger_scan: batch

    # ───────────────────────────────────────────────────────────────────────
    # ABS Search: Query Audible via ABS for books without ASIN
    # When enabled, books missing ASIN will be searched on Audible
    # to resolve metadata (author, year, series info, etc.)
    # ───────────────────────────────────────────────────────────────────────
    abs_search: true                  # Enable ABS metadata search (default: true)
    abs_search_confidence: 0.75       # Minimum match confidence (0.0-1.0)

    # ───────────────────────────────────────────────────────────────────────
    # Trumping: Quality-Based Replacement (optional)
    # See docs/audiobookshelf/TRUMPING.md for full documentation
    # ───────────────────────────────────────────────────────────────────────
    trumping:
      # Master enable/disable (default: off - opt-in feature)
      enabled: false

      # How eager to replace existing content
      # - conservative: Only trump for major upgrades (format tier changes)
      # - balanced: Trump for clear improvements (recommended when enabled)
      # - aggressive: Trump for any measurable improvement
      aggressiveness: balanced

      # Minimum bitrate improvement required (kbps) when format tier is equal
      # Set to 0 to allow any bitrate improvement
      min_bitrate_increase_kbps: 64

      # Tiebreakers: when core metrics (format, bitrate, sample rate) are equal
      prefer_chapters: true           # Chapter markers trump non-chaptered
      prefer_stereo: true             # Stereo trumps mono

      # Duration tolerance for sanity checks
      # Reject incoming if significantly shorter (truncated?)
      min_duration_ratio: 0.9         # Incoming must be >= 90% of existing duration
      # Keep both if incoming is significantly longer (different edition?)
      max_duration_ratio: 1.25        # Incoming > 125% triggers KEEP_BOTH

      # Where to archive replaced content (REQUIRED when enabled=true)
      # Old files moved to: {archive_root}/{year}/{ASIN}/{timestamp}/
      # Uncomment and set this before turning on trumping:
      # archive_root: "/mnt/user/data/audio/archive"

      # Keep archive organized by year?
      archive_by_year: true

      # Own Ripper Tags: Auto-trump existing copies with YOUR uploads
      # If incoming book has one of these ripper tags, it will ALWAYS replace
      # existing copies regardless of quality comparison. Use this to maintain
      # consistent naming/structure for your own uploads.
      # Tags are case-insensitive and should NOT include brackets.
      # Example: ["H2OKing", "MyTag"] matches [H2OKing], [h2oking], [MyTag]
      own_ripper_tags: []

    # ───────────────────────────────────────────────────────────────────────
    # Post-Import Cleanup: Manage Libation Source Files
    # See docs/audiobookshelf/CLEANUP_PLAN.md for full documentation
    # ───────────────────────────────────────────────────────────────────────
    cleanup:
      # Cleanup strategy for successfully imported books
      # - none: Leave source files in place (default, safest)
      # - hide: Add hidden marker file (prevents Libation re-download detection)
      # - move: Move source to cleanup_path for later review/deletion
      # - delete: Remove source files (DANGEROUS - data loss if seeding fails)
      strategy: none

      # Path for moved files (REQUIRED if strategy=move)
      # Uncomment and set this before using move strategy:
      # cleanup_path: "/mnt/user/data/audio/imported-cleanup"

      # Only cleanup if seeding hardlinks still exist?
      # Prevents deletion if torrent was removed from qBittorrent
      # HIGHLY RECOMMENDED to keep this enabled
      require_seed_exists: true

      # Delay cleanup until ABS API confirms book exists?
      # Extra safety check but slower (API call per book)
      verify_in_abs: false

      # Hidden marker filename (for strategy=hide)
      hide_marker: ".mamfast_imported"

      # Age-based filter: only cleanup sources older than N days (0 = disabled)
      # Useful for keeping recent imports available for troubleshooting
      min_age_days: 0

      # Prune empty directories left in staging area after import?
      # When books are trumped (replaced), shutil.move() leaves empty parent dirs.
      # This option removes those empty author/series directories.
      prune_empty_dirs: false

      # Directories to always ignore during standalone cleanup
      ignore_dirs:
        - "__import_test"
        - ".git"
        - ".venv"

      # Glob patterns to ignore
      ignore_glob:
        - "*/__*"
        - "*/.#*"
